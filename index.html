<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>面积、周长与体积</title>
  <style>
    :root{
      --bg1:#fff7fb;
      --bg2:#f3fbff;
      --card:#ffffff;
      --ink:#24324a;
      --muted:#63728a;
      --accent:#6b8cff;
      --accent2:#ff7fb0;
      --good:#25b36a;
      --warn:#ff9f43;
      --bad:#ff5a6e;
      --shadow: 0 10px 30px rgba(25, 35, 55, .12);
      --r: 18px;
      --btnR: 16px;
      --font: ui-rounded, system-ui, -apple-system, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--font);
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(107,140,255,.18), transparent 55%),
        radial-gradient(1000px 600px at 80% 0%, rgba(255,127,176,.16), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:999px;background:rgba(255,255,255,.65);box-shadow:0 6px 18px rgba(25,35,55,.08);backdrop-filter:blur(8px)}
    .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:grid;place-items:center;box-shadow:0 10px 18px rgba(107,140,255,.25)}
    .logo svg{width:22px;height:22px}
    .brand h1{font-size:18px;margin:0;line-height:1.1}

    .pillrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{background:rgba(255,255,255,.65);border-radius:999px;padding:10px 12px;box-shadow:0 6px 18px rgba(25,35,55,.08);display:flex;align-items:center;gap:10px;min-height:44px}
    .pill .k{color:var(--muted);font-weight:700}
    .stars{font-size:18px;letter-spacing:1px}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .card.soft{background:rgba(255,255,255,.75);backdrop-filter:blur(8px)}
    .title{margin:4px 0 10px;font-size:22px;letter-spacing:.5px}
    .subtitle{margin:0 0 10px;color:var(--muted);font-weight:700;font-size:14px}
    .bigTitle{font-size:34px;margin:10px 0 8px;text-align:center}
    .center{display:flex;flex-direction:column;align-items:center;gap:10px}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

    button{border:none;cursor:pointer;font-family:var(--font);font-weight:900;border-radius:var(--btnR);padding:14px 16px;font-size:18px;min-width:140px;box-shadow:0 10px 22px rgba(25,35,55,.12);transition:transform .08s ease,filter .08s ease;user-select:none;-webkit-tap-highlight-color:transparent}
    button:active{transform:translateY(1px) scale(.99);filter:saturate(.95)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .primary{background:linear-gradient(135deg,var(--accent),#7bd3ff);color:#fff}
    .secondary{background:linear-gradient(135deg,#ff93c3,var(--accent2));color:#fff}
    .ghost{background:rgba(99,114,138,.10);color:var(--ink)}
    .smallBtn{min-width:unset;padding:10px 12px;font-size:16px;border-radius:14px;box-shadow:0 8px 16px rgba(25,35,55,.10)}

    .stage{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .stage .chip{background:rgba(107,140,255,.10);border-radius:999px;padding:8px 12px;font-weight:900}
    .progress{flex:1;min-width:220px;height:12px;background:rgba(99,114,138,.14);border-radius:999px;overflow:hidden}
    .progress>div{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:999px;transition:width .25s ease}

    .prompt{display:flex;flex-direction:column;gap:10px}
    .qtext{font-size:18px;font-weight:900;margin:0;line-height:1.35}
    .hint{color:var(--muted);font-weight:800;margin:0;font-size:14px}

    .canvasWrap{border-radius:16px;background:linear-gradient(180deg,rgba(107,140,255,.08),rgba(255,127,176,.06));padding:12px;display:flex;justify-content:center;align-items:center;min-height:260px}
    svg{max-width:100%;height:auto}

    .answerRow{display:flex;gap:10px;flex-wrap:wrap;align-items:stretch;margin-top:6px}
    .inputWrap{flex:1;min-width:220px;display:flex;border-radius:16px;overflow:hidden;background:rgba(255,255,255,.92);box-shadow:inset 0 0 0 2px rgba(99,114,138,.14)}
    input{border:none;outline:none;padding:14px 14px;font-size:20px;font-weight:900;width:100%;background:transparent}
    .unit{display:grid;place-items:center;padding:0 12px;background:rgba(99,114,138,.08);color:var(--muted);font-weight:900;min-width:64px}

    .msg{margin-top:10px;padding:12px;border-radius:16px;background:rgba(255,255,255,.75);box-shadow:0 10px 22px rgba(25,35,55,.10);display:none;gap:10px;align-items:flex-start}
    .msg.show{display:flex}
    .msg .icon{width:34px;height:34px;border-radius:14px;display:grid;place-items:center;flex:0 0 auto}
    .msg.good .icon{background:rgba(37,179,106,.14);color:var(--good)}
    .msg.bad .icon{background:rgba(255,90,110,.14);color:var(--bad)}
    .msg.warn .icon{background:rgba(255,159,67,.14);color:var(--warn)}
    .msg p{margin:0}
    .msg .big{font-weight:1000;font-size:18px;margin-bottom:4px}
    .msg .eq{font-family:ui-monospace, Menlo, Consolas, monospace;font-weight:900;font-size:14px;color:var(--ink)}

    .rightCard .stat{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-radius:16px;background:rgba(99,114,138,.08);margin-bottom:10px}
    .rightCard .stat b{font-size:18px}
    .rightCard .stat span{color:var(--muted);font-weight:900}

    .levelList{display:grid;gap:10px}
    .levelBtn{width:100%;text-align:left;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px;border-radius:18px;background:rgba(255,255,255,.8);box-shadow:0 10px 22px rgba(25,35,55,.10);border:2px solid rgba(99,114,138,.12)}
    .levelBtn .left{display:flex;align-items:center;gap:10px}
    .levelBtn .num{width:44px;height:44px;border-radius:16px;display:grid;place-items:center;background:linear-gradient(135deg,rgba(107,140,255,.20),rgba(255,127,176,.18));font-size:18px;font-weight:1000}
    .levelBtn .name{font-weight:1000;font-size:16px}
    .levelBtn .desc{color:var(--muted);font-weight:800;font-size:13px}

    .toast{position:fixed;left:50%;top:14px;transform:translateX(-50%);background:rgba(255,255,255,.85);backdrop-filter:blur(10px);border-radius:999px;padding:10px 14px;box-shadow:0 10px 28px rgba(25,35,55,.14);display:none;font-weight:1000;z-index:99}
    .toast.show{display:block;animation:pop .18s ease}
    @keyframes pop{from{transform:translateX(-50%) scale(.96);opacity:.4}to{transform:translateX(-50%) scale(1);opacity:1}}

    .sparkle{position:absolute;pointer-events:none;width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff,rgba(255,255,255,.2));box-shadow:0 0 0 2px rgba(255,255,255,.35),0 10px 20px rgba(107,140,255,.25);animation:fly .65s ease forwards}
    @keyframes fly{from{transform:translate(0,0) scale(.9);opacity:1}to{transform:translate(var(--dx),var(--dy)) scale(.2);opacity:0}}
  </style>
</head>
<body>
  <div class="toast" id="toast">提示</div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand" aria-label="游戏标题">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M6 7.5h12M6 12h12M6 16.5h12" stroke="white" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1>面积、周长与体积</h1>
        </div>
      </div>

      <div class="pillrow">
        <div class="pill" title="本局累计星星">
          <span class="k">星星</span>
          <span class="stars" id="stars">⭐ 0</span>
        </div>
        <div class="pill" title="历史最高星星（本机保存）">
          <span class="k">最高</span>
          <b id="best">⭐ 0</b>
        </div>
      </div>
    </div>

    <div class="card soft" id="home">
      <div class="center">
        <div class="bigTitle">面积、周长与体积</div>
        <p class="subtitle" style="text-align:center; max-width:720px">
          通过可视化图形闯关，学会：周长、面积、体积公式。每题输入数字即可，单位会自动显示。
        </p>
      </div>

      <hr style="border:none; border-top:2px dashed rgba(99,114,138,.18); margin: 16px 0">

      <h2 class="title" style="margin-top:0">选择关卡</h2>
      <p class="subtitle">现在所有关卡都可直接进入，点击即可开始作答～</p>

      <div class="levelList" id="levelList"></div>
    </div>

    <div class="grid" id="game" style="display:none">
      <div class="card">
        <div class="stage">
          <div class="chip" id="stageChip">第 1 关</div>
          <div class="progress" aria-label="进度"><div id="prog"></div></div>
          <div class="chip" id="qCount">1 / 8</div>
        </div>

        <div class="prompt">
          <p class="qtext" id="qText">题目</p>
          <p class="hint" id="qHint">看图找已知量，然后选择合适的公式。</p>
        </div>

        <div class="canvasWrap" id="viz" aria-label="可视化图形"></div>

        <div class="answerRow">
          <div class="inputWrap" aria-label="输入答案">
            <input id="ans" inputmode="numeric" pattern="[0-9]*" autocomplete="off" placeholder="输入数字" />
            <div class="unit" id="unit">cm²</div>
          </div>
          <button class="primary" id="btnSubmit">提交</button>
          <button class="ghost" id="btnSkip">跳过</button>
        </div>

        <div class="msg" id="msg" role="status" aria-live="polite">
          <div class="icon" aria-hidden="true">
            <svg id="msgSvg" viewBox="0 0 24 24" width="20" height="20" fill="none"></svg>
          </div>
          <div>
            <p class="big" id="msgTitle">做得好！</p>
            <p id="msgBody">内容</p>
            <p class="eq" id="msgEq"></p>
            <div class="btnrow" style="justify-content:flex-start; margin-top:10px">
              <button class="smallBtn secondary" id="btnNext">下一题</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card rightCard">
        <h2 class="title" style="margin-top:0">本关信息</h2>
        <div class="stat">
          <span>本关星星</span>
          <b id="levelStars">⭐ 0</b>
        </div>
        <div class="stat">
          <span>跳过扣分</span>
          <b>⭐ -1</b>
        </div>

        <div class="card soft" style="padding:12px">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
            <b>公式小抄</b>
            <button class="smallBtn ghost" id="btnCheat">展开/收起</button>
          </div>
          <div id="cheat" style="display:none; margin-top:10px; font-weight:900; color:var(--muted); line-height:1.55">
            <div>正多边形周长：周长 = 边数 × 边长</div>
            <div>长方形面积：面积 = 长 × 宽</div>
            <div>正方形面积：面积 = 边长 × 边长</div>
            <div>三角形面积：面积 = (底 × 高) ÷ 2</div>
            <div>长方体体积：体积 = 长 × 宽 × 高</div>
            <div>正方体体积：体积 = 边长³</div>
          </div>
        </div>

        <div class="btnrow" style="justify-content:stretch">
          <button class="ghost" id="btnBack">返回首页</button>
        </div>
      </div>
    </div>

    <div class="card" id="end" style="display:none">
      <div class="center">
        <div class="bigTitle">本关完成！</div>
        <p class="subtitle" id="endText" style="text-align:center"></p>
        <div class="btnrow">
          <button class="primary" id="btnContinue">继续下一关</button>
          <button class="secondary" id="btnHome">回到首页</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  /**
   * 单文件离线小游戏
   * 已移除：提示按钮/提示次数、“再来一题”、徽章、首页多余按钮。
   * 本次修复：彻底移除易出错的 defs.innerHTML 拼接，避免因为引号/括号导致脚本解析失败。
   * 本次需求：删除“未解锁”机制——所有关卡可直接点击进入。
   */

  // =====================
  // 1) CONFIG（可改题目范围、关卡题数等）
  // =====================
  var CONFIG = {
    minVal: 3,
    maxVal: 20,
    solidMinVal: 3,
    solidMaxVal: 15,
    questionsPerLevel: 8,
    levels: [
      { id: 1, name: '正多边形周长', desc: '周长 = 边数 × 边长（边数=3~10）', types: ['perimeter_regular_polygon'] },
      { id: 2, name: '平面图形面积', desc: '正方形/长方形/三角形', types: ['area_square','area_rectangle','area_triangle'] },
      { id: 3, name: '立体体积（综合）', desc: '长方体/正方体', types: ['volume_cuboid','volume_cube'] }
    ],
    scoring: {
      correct: 2,
      skipPenalty: 1,
      unlockStarThreshold: 10 // 仅保留展示，不再用于解锁
    }
  };

  // =====================
  // 2) Storage（最高分）
  // =====================
  var STORE_KEY = 'apv_game_v2';
  function loadStore(){
    try{
      var raw = localStorage.getItem(STORE_KEY);
      if(!raw) return { bestStars: 0 };
      var d = JSON.parse(raw);
      return { bestStars: Number(d.bestStars || 0) };
    }catch(e){
      return { bestStars: 0 };
    }
  }
  function saveStore(){
    localStorage.setItem(STORE_KEY, JSON.stringify(Store));
  }
  var Store = loadStore();

  // =====================
  // 3) Helpers
  // =====================
  function getEl(id){ return document.getElementById(id); }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function toast(msg){
    var t = getEl('toast');
    if(!t) return;
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(toast._tm);
    toast._tm = setTimeout(function(){ t.classList.remove('show'); }, 1200);
  }

  function spawnSparkles(x,y){
    var n = 10;
    for(var i=0;i<n;i++){
      var s = document.createElement('div');
      s.className = 'sparkle';
      var dx = (Math.random()*2-1)*90;
      var dy = (Math.random()*2-1)*60 - 40;
      s.style.left = x+'px';
      s.style.top = y+'px';
      s.style.setProperty('--dx', dx+'px');
      s.style.setProperty('--dy', dy+'px');
      document.body.appendChild(s);
      setTimeout((function(node){ return function(){ if(node && node.remove) node.remove(); }; })(s), 700);
    }
  }

  // =====================
  // 4) Question Generator
  // =====================
  function genQuestion(level){
    var type = choice(level.types);
    var min = CONFIG.minVal;
    var max = CONFIG.maxVal;

    if(type === 'perimeter_regular_polygon'){
      var n = randInt(3,10);
      var s = randInt(min,max);
      var ans = s * n;
      return {
        type: type,
        known: { n: n, s: s },
        askText: '求正' + n + '边形的周长。',
        unit: 'cm',
        answer: ans,
        steps: { equation: '周长 = 边数×边长 = ' + n + '×' + s + ' = ' + ans }
      };
    }

    if(type === 'area_square'){
      var a = randInt(min,max);
      var ans2 = a*a;
      return {
        type: type,
        known: { a: a },
        askText: '求正方形的面积。',
        unit: 'cm²',
        answer: ans2,
        steps: { equation: '面积 = 边长×边长 = ' + a + '×' + a + ' = ' + ans2 }
      };
    }

    if(type === 'area_rectangle'){
      var L = randInt(min,max);
      var W = randInt(min,max);
      var ans3 = L*W;
      var isSquare = (L === W);
      return {
        type: type,
        known: { L: L, W: W },
        askText: isSquare ? '求正方形的面积。' : '求长方形的面积。',
        unit: 'cm²',
        answer: ans3,
        steps: { equation: (isSquare ? ('面积 = 边长×边长 = ' + L + '×' + W + ' = ' + ans3) : ('面积 = 长×宽 = ' + L + '×' + W + ' = ' + ans3)) }
      };
    }

    if(type === 'area_triangle'){
      var b, h;
      for(var k=0;k<80;k++){
        b = randInt(min,max);
        h = randInt(min,max);
        if(((b*h)%2)===0) break;
      }
      var ans4 = (b*h)/2;
      return {
        type: type,
        known: { b: b, h: h },
        askText: '求三角形的面积。',
        unit: 'cm²',
        answer: ans4,
        steps: { equation: '面积 = (底×高)÷2 = (' + b + '×' + h + ')÷2 = ' + (b*h) + '÷2 = ' + ans4 }
      };
    }

    if(type === 'volume_cuboid'){
      var sMin = CONFIG.solidMinVal;
      var sMax = CONFIG.solidMaxVal;
      var L2 = randInt(sMin, sMax);
      var W2 = randInt(sMin, sMax);
      var H2 = randInt(sMin, sMax);
      var ans5 = L2*W2*H2;
      return {
        type: type,
        known: { L: L2, W: W2, H: H2 },
        askText: '求长方体的体积。',
        unit: 'cm³',
        answer: ans5,
        steps: { equation: '体积 = 长×宽×高 = ' + L2 + '×' + W2 + '×' + H2 + ' = ' + ans5 }
      };
    }

    if(type === 'volume_cube'){
      var sMin2 = CONFIG.solidMinVal;
      var sMax2 = CONFIG.solidMaxVal;
      var a2 = randInt(sMin2, sMax2);
      var ans6 = a2*a2*a2;
      return {
        type: type,
        known: { a: a2 },
        askText: '求正方体的体积。',
        unit: 'cm³',
        answer: ans6,
        steps: { equation: '体积 = 边长³ = ' + a2 + '×' + a2 + '×' + a2 + ' = ' + ans6 }
      };
    }

    return genQuestion({types:['area_rectangle']});
  }

  // =====================
  // 5) Renderer (SVG)
  // =====================
  function renderQuestion(q){
    var box = getEl('viz');
    if(!box) return;
    box.innerHTML = '';

    var svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('viewBox','0 0 480 300');
    svg.setAttribute('role','img');

    // 用 DOM 创建 defs，避免 innerHTML 拼接引号出错导致脚本解析失败
    var defs = document.createElementNS(svg.namespaceURI,'defs');

    var filter = document.createElementNS(svg.namespaceURI,'filter');
    filter.setAttribute('id','shadow');
    filter.setAttribute('x','-20%');
    filter.setAttribute('y','-20%');
    filter.setAttribute('width','140%');
    filter.setAttribute('height','140%');
    var fe = document.createElementNS(svg.namespaceURI,'feDropShadow');
    fe.setAttribute('dx','0');
    fe.setAttribute('dy','8');
    fe.setAttribute('stdDeviation','8');
    fe.setAttribute('flood-color','#26324a');
    fe.setAttribute('flood-opacity','.12');
    filter.appendChild(fe);
    defs.appendChild(filter);

    var marker = document.createElementNS(svg.namespaceURI,'marker');
    marker.setAttribute('id','arrow');
    marker.setAttribute('viewBox','0 0 10 10');
    marker.setAttribute('refX','8');
    marker.setAttribute('refY','5');
    marker.setAttribute('markerWidth','6');
    marker.setAttribute('markerHeight','6');
    marker.setAttribute('orient','auto-start-reverse');
    var mpath = document.createElementNS(svg.namespaceURI,'path');
    mpath.setAttribute('d','M 0 0 L 10 5 L 0 10 z');
    mpath.setAttribute('fill','rgba(36,50,74,.65)');
    marker.appendChild(mpath);
    defs.appendChild(marker);

    var style = document.createElementNS(svg.namespaceURI,'style');
    // 注意：含空格的字体需加引号
    var fontFamily = "system-ui, -apple-system, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif";
    style.textContent =
      '.shape{fill: rgba(255,255,255,.88); stroke: rgba(36,50,74,.60); stroke-width: 3; filter: url(#shadow)}\n' +
      '.soft{fill: rgba(107,140,255,.10); stroke: rgba(107,140,255,.45); stroke-width: 3}\n' +
      '.dash{stroke-dasharray: 6 6}\n' +
      '.label{font-family: '+fontFamily+'; font-weight: 900; fill: rgba(36,50,74,.85); font-size: 18px}\n' +
      '.line{stroke: rgba(36,50,74,.65); stroke-width: 3}';
    defs.appendChild(style);

    svg.appendChild(defs);

    // 可爱背景点点
    var bg = document.createElementNS(svg.namespaceURI,'g');
    for(var i=0;i<26;i++){
      var c = document.createElementNS(svg.namespaceURI,'circle');
      c.setAttribute('cx', String(randInt(20,460)));
      c.setAttribute('cy', String(randInt(20,280)));
      c.setAttribute('r', String(randInt(2,4)));
      c.setAttribute('fill', (i%2)? 'rgba(107,140,255,.12)' : 'rgba(255,127,176,.10)');
      bg.appendChild(c);
    }
    svg.appendChild(bg);

    if(q.type === 'area_rectangle'){
      drawRectangle(svg, q.known.L, q.known.W, (q.known.L === q.known.W));
    }else if(q.type === 'area_square'){
      drawRectangle(svg, q.known.a, q.known.a, true);
    }else if(q.type === 'area_triangle'){
      drawTriangle(svg, q.known.b, q.known.h);
    }else if(q.type === 'perimeter_regular_polygon'){
      drawRegularPolygon(svg, q.known.n, q.known.s);
    }else if(q.type === 'volume_cuboid'){
      // 若长=宽=高，则按正方体绘制（三边等长）
      var isCubeLike = (q.known.L === q.known.W && q.known.W === q.known.H);
      drawCuboid(svg, q.known.L, q.known.W, q.known.H, isCubeLike);
    }else if(q.type === 'volume_cube'){
      drawCuboid(svg, q.known.a, q.known.a, q.known.a, true);
    }else{
      drawRectangle(svg, 8, 5, false);
    }

    box.appendChild(svg);
  }

  function addText(svg, x, y, text, cls){
    var t = document.createElementNS(svg.namespaceURI,'text');
    t.setAttribute('x', String(x));
    t.setAttribute('y', String(y));
    t.setAttribute('class', cls || 'label');
    t.textContent = text;
    svg.appendChild(t);
    return t;
  }

  function addLine(svg, x1, y1, x2, y2, cls){
    var l = document.createElementNS(svg.namespaceURI,'line');
    l.setAttribute('x1', String(x1));
    l.setAttribute('y1', String(y1));
    l.setAttribute('x2', String(x2));
    l.setAttribute('y2', String(y2));
    l.setAttribute('class', cls || 'line');
    svg.appendChild(l);
    return l;
  }

  function drawRectangle(svg, L, W, isSquare){
    var x = 140, y = 70;
    var base = isSquare ? 150 : 200; // 正方形缩小一点，避免遮挡下方文字
    var w = base;
    var h = isSquare ? base : 140;

    var rect = document.createElementNS(svg.namespaceURI,'rect');
    rect.setAttribute('x', x);
    rect.setAttribute('y', y);
    rect.setAttribute('width', w);
    rect.setAttribute('height', h);
    rect.setAttribute('rx', 18);
    rect.setAttribute('class','shape');
    svg.appendChild(rect);

    var lenLine = addLine(svg, x, y+h+22, x+w, y+h+22, 'line');
    lenLine.setAttribute('marker-start','url(#arrow)');
    lenLine.setAttribute('marker-end','url(#arrow)');
    addText(svg, x+w/2-52, y+h+50, isSquare ? ('边长 ' + L + ' cm') : ('长 ' + L + ' cm'));

    var widLine = addLine(svg, x+w+22, y, x+w+22, y+h, 'line');
    widLine.setAttribute('marker-start','url(#arrow)');
    widLine.setAttribute('marker-end','url(#arrow)');
    addText(svg, x+w+30, y+h/2+6, isSquare ? ('边长 ' + W + ' cm') : ('宽 ' + W + ' cm'));

    addText(svg, 20, 42, isSquare ? '正方形（平面图）' : '长方形（平面图）');
  }

  function drawTriangle(svg, b, h){
    var A = {x:120, y:220};
    var B = {x:360, y:220};
    var C = {x:260, y:80};

    var path = document.createElementNS(svg.namespaceURI,'path');
    path.setAttribute('d', 'M ' + A.x + ' ' + A.y + ' L ' + B.x + ' ' + B.y + ' L ' + C.x + ' ' + C.y + ' Z');
    path.setAttribute('class','shape');
    svg.appendChild(path);

    // 高（虚线）
    var D = {x: C.x, y: A.y};
    addLine(svg, C.x, C.y, D.x, D.y, 'line dash');

    // 直角符号
    var r = 16;
    var right = document.createElementNS(svg.namespaceURI,'path');
    right.setAttribute('d', 'M ' + D.x + ' ' + D.y + ' m 0 -' + r + ' l ' + r + ' 0 l 0 ' + r);
    right.setAttribute('fill','none');
    right.setAttribute('class','line');
    svg.appendChild(right);

    // 底
    var base = addLine(svg, A.x, A.y+22, B.x, A.y+22, 'line');
    base.setAttribute('marker-start','url(#arrow)');
    base.setAttribute('marker-end','url(#arrow)');
    addText(svg, (A.x+B.x)/2-46, A.y+50, '底 ' + b + ' cm');

    // 高
    var hh = addLine(svg, D.x+22, C.y, D.x+22, D.y, 'line');
    hh.setAttribute('marker-start','url(#arrow)');
    hh.setAttribute('marker-end','url(#arrow)');
    addText(svg, D.x+34, (C.y+D.y)/2+6, '高 ' + h + ' cm');

    addText(svg, 20, 42, '三角形（底与高）');
  }

  function drawRegularPolygon(svg, n, s){
    var cx=240, cy=155, R=90;
    var pts = [];
    var start = -Math.PI/2;
    for(var i=0;i<n;i++){
      var ang = start + i*(2*Math.PI/n);
      pts.push([cx + R*Math.cos(ang), cy + R*Math.sin(ang)]);
    }

    var poly = document.createElementNS(svg.namespaceURI,'polygon');
    var pstr = '';
    for(var j=0;j<pts.length;j++){
      if(j) pstr += ' ';
      pstr += pts[j][0].toFixed(1) + ',' + pts[j][1].toFixed(1);
    }
    poly.setAttribute('points', pstr);
    poly.setAttribute('class','shape');
    svg.appendChild(poly);

    addText(svg, 20, 42, '正' + n + '边形');
    addText(svg, 20, 70, '边数 = ' + n);
    addText(svg, 20, 98, '边长 = ' + s + ' cm');

    // 高亮一条边
    var p0 = pts[0], p1 = pts[1];
    var hi = addLine(svg, p0[0], p0[1], p1[0], p1[1], 'line');
    hi.setAttribute('stroke','rgba(255,127,176,.9)');
    hi.setAttribute('stroke-width','5');
  }

  function drawCuboid(svg, L, W, H, isCube){
    // ===== 立体绘制（自动适配画布，保证整体与标注完整显示） =====
    var VBW = 480, VBH = 300;
    var PAD = 16;

    var fx = 70;
    var fy = 90;

    var fw, fh, depth, dx, dy;

    if(isCube){
      var size = 120;
      fw = fh = depth = size;
      dx = Math.round(size * 0.45);
      dy = -Math.round(size * 0.45);
    }else{
      var maxDim = Math.max(L, W, H);
      var base = 150;
      var scale = base / maxDim;

      fw = Math.round(L * scale);
      fh = Math.round(H * scale);
      depth = Math.round(W * scale);

      dx = Math.round(depth * 0.70);
      dy = -Math.round(depth * 0.70);
    }

    var RIGHT_LABEL = 170;
    var BOTTOM_LABEL = 85;

    var bodyW = fw + dx;
    var bodyH = fh - dy;

    var needW = bodyW + RIGHT_LABEL;
    var needH = bodyH + BOTTOM_LABEL;

    var fit = Math.min(1,
      (VBW - PAD*2) / needW,
      (VBH - PAD*2) / needH
    );

    if(fit < 1){
      fw = Math.max(30, Math.round(fw * fit));
      fh = Math.max(30, Math.round(fh * fit));
      dx = Math.max(18, Math.round(dx * fit));
      dy = -Math.max(18, Math.round((-dy) * fit));
      bodyW = fw + dx;
      bodyH = fh - dy;
    }

    var availW = VBW - PAD*2 - RIGHT_LABEL;
    fx = PAD + Math.max(6, Math.floor((availW - bodyW) / 2));

    var availH = VBH - PAD*2 - BOTTOM_LABEL;
    var topY = PAD + Math.max(6, Math.floor((availH - bodyH) / 2));
    fy = topY - dy;

    var FTL = {x:fx,      y:fy};
    var FTR = {x:fx+fw,   y:fy};
    var FBL = {x:fx,      y:fy+fh};
    var FBR = {x:fx+fw,   y:fy+fh};

    var BTR = {x:fx+fw+dx,y:fy+dy};
    var BBR = {x:fx+fw+dx,y:fy+fh+dy};

    var front = 'M '+FTL.x+' '+FTL.y+' L '+FTR.x+' '+FTR.y+' L '+FBR.x+' '+FBR.y+' L '+FBL.x+' '+FBL.y+' Z';
    var top   = 'M '+FTL.x+' '+FTL.y+' L '+(FTL.x+dx)+' '+(FTL.y+dy)+' L '+BTR.x+' '+BTR.y+' L '+FTR.x+' '+FTR.y+' Z';
    var side  = 'M '+FTR.x+' '+FTR.y+' L '+BTR.x+' '+BTR.y+' L '+BBR.x+' '+BBR.y+' L '+FBR.x+' '+FBR.y+' Z';

    var pTop = document.createElementNS(svg.namespaceURI,'path');
    pTop.setAttribute('d', top);
    pTop.setAttribute('class','soft');
    svg.appendChild(pTop);

    var pSide = document.createElementNS(svg.namespaceURI,'path');
    pSide.setAttribute('d', side);
    pSide.setAttribute('class','soft');
    pSide.setAttribute('fill','rgba(255,127,176,.10)');
    svg.appendChild(pSide);

    var pFront = document.createElementNS(svg.namespaceURI,'path');
    pFront.setAttribute('d', front);
    pFront.setAttribute('class','shape');
    svg.appendChild(pFront);

    addLine(svg, FTL.x, FTL.y, FTL.x+dx, FTL.y+dy, 'line');
    addLine(svg, FTR.x, FTR.y, BTR.x, BTR.y, 'line');
    addLine(svg, FBR.x, FBR.y, BBR.x, BBR.y, 'line');
    addLine(svg, FTL.x+dx, FTL.y+dy, BTR.x, BTR.y, 'line');
    addLine(svg, BTR.x, BTR.y, BBR.x, BBR.y, 'line');

    var lenLine = addLine(svg, FBL.x, FBL.y+22, FBR.x, FBR.y+22, 'line');
    lenLine.setAttribute('marker-start','url(#arrow)');
    lenLine.setAttribute('marker-end','url(#arrow)');
    addText(svg, (FBL.x+FBR.x)/2-48, FBL.y+50, isCube ? ('边长 '+L+' cm') : ('长 '+L+' cm'));

    var vx = (BBR.x - FBR.x), vy = (BBR.y - FBR.y);
    var vlen = Math.sqrt(vx*vx + vy*vy) || 1;
    var nx = (-vy)/vlen, ny = (vx)/vlen;
    var off = 18;
    var wx1 = FBR.x + nx*off, wy1 = FBR.y + ny*off;
    var wx2 = BBR.x + nx*off, wy2 = BBR.y + ny*off;
    var widLine = addLine(svg, wx1, wy1, wx2, wy2, 'line');
    widLine.setAttribute('marker-start','url(#arrow)');
    widLine.setAttribute('marker-end','url(#arrow)');
    addText(svg, (wx1+wx2)/2 + nx*36 + 8, (wy1+wy2)/2 + ny*36 + 8,
      isCube ? ('边长 '+W+' cm') : ('宽 '+W+' cm'));

    var hx = BTR.x + 22, hy1 = BTR.y, hy2 = BBR.y;
    var htLine = addLine(svg, hx, hy1, hx, hy2, 'line');
    htLine.setAttribute('marker-start','url(#arrow)');
    htLine.setAttribute('marker-end','url(#arrow)');
    addText(svg, hx + 22, (hy1+hy2)/2 + 6,
      isCube ? ('边长 '+H+' cm') : ('高 '+H+' cm'));
  }

  // =====================
  // 6) Judge / Feedback
  // =====================
  function setMsg(kind, title, body, eq){
    var msg = getEl('msg');
    if(!msg) return;
    msg.className = 'msg show ' + kind;

    var t = getEl('msgTitle'); if(t) t.textContent = title;
    var b = getEl('msgBody');  if(b) b.textContent = body;
    var e = getEl('msgEq');    if(e) e.textContent = eq || '';

    var svg = getEl('msgSvg');
    if(!svg) return;
    svg.innerHTML = '';
    if(kind==='good'){
      svg.innerHTML = '<path d="M20 7L10 17l-4-4" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>';
    }else if(kind==='bad'){
      svg.innerHTML = '<path d="M7 7l10 10M17 7L7 17" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>';
    }else{
      svg.innerHTML = '<path d="M12 8v5" stroke="currentColor" stroke-width="3" stroke-linecap="round"/><path d="M12 17h.01" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>';
    }
  }

  // =====================
  // 7) UI Controller
  // =====================
  var State = {
    mode: 'home',
    levelIndex: 0,
    qIndex: 0,
    qTotal: CONFIG.questionsPerLevel,
    current: null,
    totalStars: 0,
    levelStars: 0,
    answeredLocked: false
  };

  function syncTop(){
    var s = getEl('stars'); if(s) s.textContent = '⭐ ' + State.totalStars;
    var b = getEl('best');  if(b) b.textContent = '⭐ ' + Store.bestStars;
  }

  function renderLevels(){
    var box = getEl('levelList');
    if(!box) return;
    box.innerHTML = '';

    for(var i=0;i<CONFIG.levels.length;i++){
      (function(idx){
        var lv = CONFIG.levels[idx];

        var btn = document.createElement('button');
        btn.className = 'levelBtn';
        btn.type = 'button';
        btn.innerHTML =
          '<div class="left">' +
            '<div class="num">' + lv.id + '</div>' +
            '<div>' +
              '<div class="name">' + lv.name + '</div>' +
              '<div class="desc">' + lv.desc + '</div>' +
            '</div>' +
          '</div>' +
          '<div style="font-weight:900; color:rgba(36,50,74,.85)">✅ 可挑战</div>';

        btn.addEventListener('click', function(){
          startLevel(idx);
        });

        box.appendChild(btn);
      })(i);
    }
  }

  function startLevel(levelIndex){
    State.mode = 'play';
    State.levelIndex = levelIndex;
    State.qIndex = 0;
    State.qTotal = CONFIG.questionsPerLevel;
    State.levelStars = 0;
    State.totalStars = 0;
    State.answeredLocked = false;

    var home = getEl('home'); if(home) home.style.display='none';
    var end  = getEl('end');  if(end)  end.style.display='none';
    var game = getEl('game'); if(game) game.style.display='grid';

    syncTop();
    nextQuestion(true);
  }

  function updateHUD(){
    var lv = CONFIG.levels[State.levelIndex];
    var chip = getEl('stageChip'); if(chip) chip.textContent = '第 ' + lv.id + ' 关：' + lv.name;
    var qc = getEl('qCount'); if(qc) qc.textContent = (State.qIndex+1) + ' / ' + State.qTotal;
    var prog = getEl('prog'); if(prog) prog.style.width = ((State.qIndex/State.qTotal)*100) + '%';
    var ls = getEl('levelStars'); if(ls) ls.textContent = '⭐ ' + State.levelStars;
  }

  function setInputUnit(u){
    var unit = getEl('unit'); if(unit) unit.textContent = u;
  }

  function lockAfterAnswer(locked){
    State.answeredLocked = locked;
    var submit = getEl('btnSubmit'); if(submit) submit.disabled = locked;
    var skip = getEl('btnSkip'); if(skip) skip.disabled = locked;
    var ans = getEl('ans'); if(ans) ans.disabled = locked;
  }

  function clearMsg(){
    var msg = getEl('msg'); if(msg) msg.className = 'msg';
    var eq = getEl('msgEq'); if(eq) eq.textContent = '';
  }

  function nextQuestion(isFirst){
    clearMsg();
    lockAfterAnswer(false);

    var ansEl = getEl('ans');
    if(ansEl){ ansEl.value = ''; ansEl.focus(); }

    var lv = CONFIG.levels[State.levelIndex];
    State.current = genQuestion(lv);

    var qt = getEl('qText'); if(qt) qt.textContent = State.current.askText;
    var qh = getEl('qHint'); if(qh) qh.textContent = '看图找已知量，然后选择合适的公式。';
    setInputUnit(State.current.unit);

    renderQuestion(State.current);
    updateHUD();

    if(!isFirst){
      var prog = getEl('prog');
      if(prog) prog.style.width = ((State.qIndex/State.qTotal)*100) + '%';
    }
  }

  function finishLevel(){
    State.mode = 'end';

    var game = getEl('game'); if(game) game.style.display='none';
    var end  = getEl('end');  if(end)  end.style.display='block';

    var prog = getEl('prog'); if(prog) prog.style.width = '100%';

    if(State.totalStars > Store.bestStars){
      Store.bestStars = State.totalStars;
      toast('新纪录！');
    }

    saveStore();
    syncTop();
    renderLevels();

    var lv = CONFIG.levels[State.levelIndex];
    var nextId = lv.id + 1;
    var hasNext = nextId <= CONFIG.levels.length;
    var cont = getEl('btnContinue');
    if(cont) cont.style.display = hasNext ? 'inline-block' : 'none';

    var endText = getEl('endText');
    if(endText){
      endText.textContent = '本关获得 ⭐ ' + State.levelStars + '，本局累计 ⭐ ' + State.totalStars + '。';
    }
  }

  function showCorrect(eq){
    lockAfterAnswer(true);
    var gain = CONFIG.scoring.correct;
    State.levelStars += gain;
    State.totalStars += gain;
    syncTop();
    updateHUD();
    setMsg('good','做得好！', '答对啦！获得 ⭐ +' + gain, eq);
  }

  function submit(){
    if(State.answeredLocked) return;

    var input = getEl('ans');
    var raw = input ? String(input.value).trim() : '';
    if(!raw){ toast('先输入答案～'); return; }

    var val = Number(raw);
    if(!isFinite(val)){ toast('请输入数字～'); return; }

    var q = State.current;
    if(!q){ toast('题目加载失败，请刷新重试'); return; }

    if(val === q.answer){
      showCorrect(q.steps && q.steps.equation ? q.steps.equation : '');
    }else{
      setMsg('bad','再想想～', '再检查一下题目和图形标注吧～', '');
      lockAfterAnswer(false);
    }
  }

  function skip(){
    if(State.answeredLocked) return;

    var p = CONFIG.scoring.skipPenalty;
    State.levelStars = Math.max(0, State.levelStars - p);
    State.totalStars = Math.max(0, State.totalStars - p);
    syncTop();
    updateHUD();

    var q = State.current;
    var eq = (q && q.steps && q.steps.equation) ? q.steps.equation : '';
    setMsg('warn','跳过啦～', '扣 ⭐ -' + p + '。答案是 ' + (q ? q.answer : '—') + '。', eq);
    lockAfterAnswer(true);
  }

  function next(){
    if(!State.answeredLocked){
      toast('先提交或跳过，再下一题～');
      return;
    }

    State.qIndex++;
    if(State.qIndex >= State.qTotal){
      finishLevel();
      return;
    }

    nextQuestion(false);
  }

  function backHome(){
    State.mode='home';

    var game = getEl('game'); if(game) game.style.display='none';
    var end  = getEl('end');  if(end)  end.style.display='none';
    var home = getEl('home'); if(home) home.style.display='block';

    syncTop();
    renderLevels();
  }

  // =====================
  // 8) Self-tests（console）
  // =====================
  function runSelfTests(){
    for(var i=0;i<200;i++){
      var q = genQuestion({types:['area_triangle']});
      if(q.answer !== Math.floor(q.answer)){
        console.error('TEST FAIL: triangle area not integer', q);
        return;
      }
    }

    for(var j=0;j<80;j++){
      var p = genQuestion({types:['perimeter_regular_polygon']});
      if(p.answer !== p.known.n * p.known.s){
        console.error('TEST FAIL: polygon perimeter mismatch', p);
        return;
      }
      if(String(p.steps.equation).indexOf('<') !== -1){
        console.error('TEST FAIL: equation contains HTML', p);
        return;
      }
    }

    (function(){
      var L=11, W=13, H=17;
      var maxDim = Math.max(L,W,H);
      var base = 150;
      var scale = base/maxDim;
      var fw = Math.round(L*scale);
      var fh = Math.round(H*scale);
      if(!(fh > fw)){
        console.error('TEST FAIL: cuboid比例不对（fh应大于fw）');
        return;
      }
    })();

    console.log('Self-tests passed ✅');
  }

  // =====================
  // 9) 事件绑定
  // =====================
  function bind(){
    var btnSubmit = getEl('btnSubmit');
    if(btnSubmit){
      btnSubmit.addEventListener('click', function(e){
        var r = e.currentTarget.getBoundingClientRect();
        spawnSparkles(r.left + r.width/2, r.top + r.height/2);
        submit();
      });
    }

    var btnSkip = getEl('btnSkip'); if(btnSkip) btnSkip.addEventListener('click', skip);
    var btnNext = getEl('btnNext'); if(btnNext) btnNext.addEventListener('click', next);
    var btnBack = getEl('btnBack'); if(btnBack) btnBack.addEventListener('click', backHome);
    var btnHome = getEl('btnHome'); if(btnHome) btnHome.addEventListener('click', backHome);

    var btnContinue = getEl('btnContinue');
    if(btnContinue){
      btnContinue.addEventListener('click', function(){
        var nextLevel = clamp(State.levelIndex+1, 0, CONFIG.levels.length-1);
        startLevel(nextLevel);
      });
    }

    var btnCheat = getEl('btnCheat');
    if(btnCheat){
      btnCheat.addEventListener('click', function(){
        var c = getEl('cheat');
        if(!c) return;
        c.style.display = (c.style.display==='none' || !c.style.display) ? 'block' : 'none';
      });
    }

    var ans = getEl('ans');
    if(ans){
      ans.addEventListener('keydown', function(e){
        if(e.key === 'Enter') submit();
      });
    }
  }

  function init(){
    syncTop();
    renderLevels();
    bind();
    runSelfTests();
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  }else{
    init();
  }
  </script>
</body>
</html>
